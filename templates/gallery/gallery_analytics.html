{% extends 'base.html' %}
{% load gallery_extras %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none transition-all duration-300"></div>
<div class="min-h-screen bg-[#050505] text-white font-sans flex flex-col selection:bg-white selection:text-black">
    <nav class="border-b border-white/10 bg-[#0a0a0a] px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-6">
          <a href="{% url 'dashboard' %}" class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Назад
          </a>
          <div class="h-6 w-[1px] bg-white/10"></div>
          <div>
              <h1 class="font-bold text-lg leading-none tracking-tight">{{ gallery.title }}</h1>
              <span class="text-[10px] text-gray-500 uppercase tracking-widest">Аналитика и Управление</span>
          </div>
        </div>
        <div class="flex gap-4 items-center">
             <label class="flex items-center gap-2 cursor-pointer text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white transition-colors select-none">
                 <div class="relative">
                     <input type="checkbox" id="authorToggle" class="sr-only peer" onchange="toggleAuthorStats(this)" {% if include_author %}checked{% endif %}>
                     <div class="w-8 h-4 bg-gray-700 rounded-full shadow-inner transition-colors duration-200 ease-in-out peer-checked:bg-white"></div>
                     <div class="absolute w-2 h-2 bg-white rounded-full shadow inset-y-1 left-1 transition-transform duration-200 ease-in-out peer-checked:translate-x-4 peer-checked:bg-black"></div>
                 </div>
                 <span>Учитывать автора</span>
             </label>
             <div class="hidden md:flex bg-[#111] rounded p-1 border border-[#222]">
                <button onclick="switchTab('OVERVIEW')" id="tab-btn-OVERVIEW" class="flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all bg-white text-black shadow-lg">
                    <i data-lucide="layout-dashboard" class="w-3.5 h-3.5"></i> Обзор
                </button>
                <button onclick="switchTab('PHOTOS')" id="tab-btn-PHOTOS" class="flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all text-gray-500 hover:text-white">
                    <i data-lucide="grid" class="w-3.5 h-3.5"></i> Фотографии
                </button>
            </div>
             <a href="{% url 'gallery_settings' gallery.id %}" class="w-10 h-10 flex items-center justify-center rounded-full border border-white/10 hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-4 h-4"></i>
             </a>
        </div>
    </nav>
    <main class="flex-1 p-6 md:p-8 max-w-[1920px] mx-auto w-full">
        <div id="tab-content-OVERVIEW" class="animate-in fade-in duration-500">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- KPI Funnel -->
                <div class="lg:col-span-1 bg-[#0a0a0a] border border-white/10 p-6 rounded-sm h-[320px] flex flex-col relative overflow-hidden">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Воронка выбора</h3>
                    <div class="relative flex-1 flex items-center justify-center min-h-0 w-full">
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10">
                            <span class="text-3xl font-bold text-white">{{ selected_count }}</span>
                            <span class="text-[9px] text-gray-500 uppercase tracking-widest">Выбрано</span>
                        </div>
                        <div class="absolute inset-0">
                             <canvas id="kpiChart"></canvas>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between text-xs text-gray-400 px-2 pt-2 border-t border-white/5">
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-white"></div> Выбрано</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Просм.</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#333]"></div> Ост.</div>
                    </div>
                </div>

                <!-- Main Dynamic Chart -->
                <div class="lg:col-span-3 bg-[#0a0a0a] border border-white/10 p-6 rounded-sm h-[320px] flex flex-col">
                     <div class="flex justify-between items-center mb-4">
                         <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Динамика проекта</h3>
                         <select id="chartSelector" onchange="updateDynamicChart(this.value)" class="bg-[#111] text-white text-xs border border-[#333] rounded px-3 py-1 outline-none cursor-pointer hover:border-white transition-colors">
                             <option value="activity">Активность по дням</option>
                             <option value="top">Топ-10 фото</option>
                         </select>
                     </div>
                     <div class="flex-1 w-full relative min-h-0">
                        <canvas id="dynamicChart"></canvas>
                     </div>
                </div>

                <!-- Recent Comments Widget -->
                <div class="lg:col-span-2 bg-[#0a0a0a] border border-white/10 rounded-sm overflow-hidden flex flex-col h-[400px]">
                    <div class="p-4 border-b border-white/10 bg-[#111] flex justify-between items-center">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Последние комментарии</h3>
                        <button onclick="openModalWindow('modal-all-comments')" class="text-[9px] font-bold text-white uppercase hover:underline">Все ({{ all_comments_list.count }})</button>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto custom-scrollbar">
                        {% for c in all_comments_list|slice:":5" %}
                        <div class="mb-4 last:mb-0 pb-4 border-b border-white/5 last:border-0 cursor-pointer group" onclick="scrollToPhoto('{{ c.photo.id }}')">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-bold text-white group-hover:text-blue-400 transition-colors uppercase">{{ c.client.username }}</span>
                                <span class="text-[9px] font-mono text-gray-600">#{{ c.photo.sequence_number }} | {{ c.timestamp|date:"d.m H:i" }}</span>
                            </div>
                            <p class="text-xs text-gray-400 italic">"{{ c.comment }}"</p>
                        </div>
                        {% empty %}
                        <div class="py-10 text-center text-gray-600 text-xs uppercase tracking-widest">Нет комментариев</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Recent Activity Widget -->
                <div class="lg:col-span-2 bg-[#0a0a0a] border border-white/10 rounded-sm overflow-hidden flex flex-col h-[400px]">
                    <div class="p-4 border-b border-white/10 bg-[#111] flex justify-between items-center">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Лог активности</h3>
                        <button onclick="openModalWindow('modal-all-activity')" class="text-[9px] font-bold text-white uppercase hover:underline">Полный лог</button>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto custom-scrollbar">
                        {% for log in activity_log|slice:":10" %}
                        <div class="flex items-center justify-between py-2 border-b border-white/5 last:border-0 cursor-pointer group" onclick="scrollToPhoto('{{ log.photo.id }}')">
                            <div class="flex items-center gap-3">
                                <div class="w-1.5 h-1.5 rounded-full {% if log.is_liked %}bg-white{% else %}bg-blue-500{% endif %}"></div>
                                <span class="text-xs text-gray-300 group-hover:text-white transition-colors">
                                    <span class="font-bold text-white">{{ log.client.username }}</span> 
                                    {% if log.is_liked %}лайкнул(а){% else %}посмотрел(а){% endif %} 
                                    фото <span class="font-mono text-[10px]">#{{ log.photo.sequence_number }}</span>
                                </span>
                            </div>
                            <span class="text-[9px] font-mono text-gray-600">{{ log.timestamp|date:"H:i" }}</span>
                        </div>
                        {% empty %}
                        <div class="py-10 text-center text-gray-600 text-xs uppercase tracking-widest">Нет действий</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modal-all-comments" class="hidden fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-[#0a0a0a] border border-white/10 rounded flex flex-col max-h-[80vh]">
                <div class="p-6 border-b border-white/10 flex justify-between items-center">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-white">Все комментарии галереи</h2>
                    <button onclick="closeModalWindow('modal-all-comments')" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    {% for c in all_comments_list %}
                    <div class="mb-6 last:mb-0 pb-6 border-b border-white/5 last:border-0 cursor-pointer group" onclick="scrollToPhoto('{{ c.photo.id }}'); closeModalWindow('modal-all-comments')">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-bold text-gray-400">{{ c.client.username|first|upper }}</div>
                                <div>
                                    <p class="text-[10px] font-bold text-white uppercase tracking-wider group-hover:text-blue-400 transition-colors">{{ c.client.username }}</p>
                                    <p class="text-[9px] text-gray-600 font-mono">Файл: IMG_{{ c.photo.sequence_number|stringformat:"04d" }}</p>
                                </div>
                            </div>
                            <span class="text-[9px] font-mono text-gray-600">{{ c.timestamp|date:"d.m.Y H:i" }}</span>
                        </div>
                        <p class="text-sm text-gray-300 italic pl-11">"{{ c.comment }}"</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="modal-all-activity" class="hidden fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-[#0a0a0a] border border-white/10 rounded flex flex-col max-h-[80vh]">
                <div class="p-6 border-b border-white/10 flex justify-between items-center">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-white">Полный лог активности</h2>
                    <button onclick="closeModalWindow('modal-all-activity')" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar">
                    <div class="space-y-1">
                        {% for log in activity_log %}
                        <div class="flex items-center justify-between py-3 border-b border-white/5 last:border-0 hover:bg-white/5 px-2 transition-all cursor-pointer group" onclick="scrollToPhoto('{{ log.photo.id }}'); closeModalWindow('modal-all-activity')">
                            <div class="flex items-center gap-4">
                                <div class="w-2 h-2 rounded-full {% if log.is_liked %}bg-white shadow-[0_0_8px_rgba(255,255,255,0.5)]{% else %}bg-blue-500{% endif %}"></div>
                                <div class="text-xs">
                                    <span class="font-bold text-white uppercase tracking-tighter">{{ log.client.username }}</span>
                                    <span class="text-gray-500">
                                        {% if log.is_liked %}добавил(а) в избранное{% else %}просмотрел(а) оригинал{% endif %} 
                                        фото <span class="font-mono font-bold text-gray-300">#{{ log.photo.sequence_number }}</span>
                                    </span>
                                </div>
                            </div>
                            <span class="text-[9px] font-mono text-gray-600">{{ log.timestamp|date:"d.m H:i" }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-content-PHOTOS" class="hidden animate-in slide-in-from-bottom-2 duration-500">
            <div class="bg-[#0a0a0a] border border-white/10 rounded-sm min-h-[calc(100vh-140px)] flex flex-col">
                <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-[#111] border-b border-white/10 text-[10px] font-bold uppercase tracking-widest text-gray-500">
                    <div class="col-span-1">Превью</div>
                    <div class="col-span-3">Имя файла</div>
                    <div class="col-span-2">Статус</div>
                    <div class="col-span-4">Комментарии / Примечания</div>
                    <div class="col-span-2 text-right">Действия</div>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-1 max-h-[70vh]">
                    {% for item in photos_data %}
                    <div data-photo-id="{{ item.id }}" class="grid grid-cols-12 gap-4 px-6 py-4 border-b border-[#222] items-center hover:bg-[#0f0f0f] transition-all duration-500">
                        <div class="col-span-1 h-10 w-16 bg-[#111] overflow-hidden rounded border border-[#333]">
                            <img src="{{ item.thumbnail }}" class="w-full h-full object-cover" loading="lazy">
                        </div>
                        <div class="col-span-3 font-mono text-[11px] text-gray-300 truncate">{{ item.filename }}</div>
                        <div class="col-span-2">
                            {% if item.is_liked %}
                                <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded bg-white text-black text-[9px] font-bold uppercase tracking-wider">
                                    <i data-lucide="heart" class="w-2.5 h-2.5 fill-black"></i> Выбрано
                                </span>
                            {% else %}
                                <span class="text-gray-600 text-[9px] uppercase tracking-wider">—</span>
                            {% endif %}
                        </div>
                        <div class="col-span-4 text-[11px] text-gray-400 italic truncate">
                            {% if item.comment %}<span class="text-white not-italic font-bold">К:</span> {{ item.comment }}{% endif %}
                            {% if item.photographer_note %}<br><span class="text-blue-400 not-italic font-bold">П:</span> {{ item.photographer_note }}{% endif %}
                            {% if not item.comment and not item.photographer_note %}-{% endif %}
                        </div>
                        <div class="col-span-2 text-right">
                            <button onclick="previewPhoto('{{ item.full_url }}', '{{ item.filename }}')" class="text-[9px] font-bold uppercase tracking-widest text-white border border-white/10 px-3 py-1.5 hover:bg-white hover:text-black transition-all">Просмотреть</button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-10 text-center text-gray-600 text-sm">Нет фотографий</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Photo Preview Modal -->
<div id="preview-modal" class="hidden fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center p-4" onclick="closePreview()">
    <button class="absolute top-8 right-8 text-white/50 hover:text-white transition-colors">
        <i data-lucide="x" class="w-8 h-8"></i>
    </button>
    <img id="preview-img" src="" class="max-w-full max-h-[85vh] object-contain shadow-2xl rounded-sm">
    <p id="preview-caption" class="mt-6 text-[10px] font-mono text-gray-500 uppercase tracking-[0.2em]"></p>
</div>

<script>
    function previewPhoto(url, name) {
        document.getElementById('preview-img').src = url;
        document.getElementById('preview-caption').textContent = name;
        document.getElementById('preview-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    function closePreview() {
        document.getElementById('preview-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    function openModalWindow(id) {
        document.getElementById(id).classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    function closeModalWindow(id) {
        document.getElementById(id).classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    window.scrollToPhoto = function(photoId) {
        switchTab('PHOTOS');
        setTimeout(() => {
            const photoEl = document.querySelector(`[data-photo-id="${photoId}"]`);
            if (photoEl) {
                photoEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                photoEl.style.outline = '2px solid white';
                photoEl.style.backgroundColor = 'rgba(255,255,255,0.05)';
                setTimeout(() => {
                    photoEl.style.outline = 'none';
                    photoEl.style.backgroundColor = '';
                }, 3000);
            }
        }, 100);
    }
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgClass = isError ? 'bg-red-600 border-red-500' : 'bg-white border-white';
        const textClass = isError ? 'text-white' : 'text-black';
        toast.className = `pointer-events-auto transform translate-y-[-20px] opacity-0 transition-all duration-300 flex items-center justify-between gap-4 px-6 py-3 rounded shadow-2xl border ${bgClass} ${textClass} min-w-[300px] max-w-md`;
        toast.innerHTML = `<div class="flex items-center gap-3"><i data-lucide="${isError ? 'alert-circle' : 'check-circle'}" class="w-5 h-5"></i><span class="text-xs font-bold uppercase tracking-widest">${message}</span></div>`;
        container.appendChild(toast);
        lucide.createIcons();
        requestAnimationFrame(() => toast.classList.remove('translate-y-[-20px]', 'opacity-0'));
        setTimeout(() => { toast.classList.add('translate-y-[-20px]', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
    function toggleAuthorStats(checkbox) {
        const url = new URL(window.location);
        if (checkbox.checked) {
            url.searchParams.set('include_author', 'true');
        } else {
            url.searchParams.delete('include_author');
        }
        window.location.href = url.toString();
    }
    function switchTab(tabName) {
        document.getElementById('tab-content-OVERVIEW').classList.add('hidden');
        document.getElementById('tab-content-PHOTOS').classList.add('hidden');
        document.getElementById('tab-btn-OVERVIEW').className = "flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all text-gray-500 hover:text-white";
        document.getElementById('tab-btn-PHOTOS').className = "flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all text-gray-500 hover:text-white";
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
        document.getElementById('tab-btn-' + tabName).className = "flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all bg-white text-black shadow-lg";
    }
    function copyLink() {
        const url = "{{ request.scheme }}://{{ request.get_host }}{% url 'gallery_detail' gallery.photographer.id gallery.id %}";
        navigator.clipboard.writeText(url);
        showToast('Ссылка скопирована!');
    }
    document.addEventListener("DOMContentLoaded", function() {
        {% if messages %}
            {% for message in messages %}
                showToast("{{ message }}", "{{ message.tags }}" === "error");
            {% endfor %}
        {% endif %}
    });
    new Chart(document.getElementById('kpiChart'), {
        type: 'doughnut',
        data: {
            labels: ['Выбрано', 'Просмотрено', 'Не просмотрено'],
            datasets: [{
                data: [{{ selected_count }}, {{ viewed_count }}, {{ unviewed_count }}],
                backgroundColor: ['#ffffff', '#3b82f6', '#333333'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: { legend: { display: false } }
        }
    });
    let dynamicChartInstance = null;
    const ctxDynamic = document.getElementById('dynamicChart').getContext('2d');
    const dataActivity = {
        type: 'line',
        labels: {{ activity_dates|safe }},
        datasets: [
            {
                label: 'Лайки',
                data: {{ activity_likes|safe }},
                borderColor: '#ffffff',
                backgroundColor: 'rgba(255,255,255,0.05)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'Просмотры',
                data: {{ activity_views|safe }},
                borderColor: '#3b82f6',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                tension: 0.4
            },
            {
                label: 'Комментарии',
                data: {{ activity_comments|safe }},
                borderColor: '#22c55e',
                backgroundColor: 'transparent',
                tension: 0.4
            }
        ]
    };
    const dataTop = {
        type: 'bar',
        labels: {{ top_labels|safe }},
        datasets: [{
            label: 'Лайки',
            data: {{ top_data|safe }},
            backgroundColor: '#ffffff',
            borderRadius: 4
        }]
    };
    function renderDynamicChart(config) {
        if (dynamicChartInstance) dynamicChartInstance.destroy();
        dynamicChartInstance = new Chart(ctxDynamic, {
            type: config.type,
            data: { labels: config.labels, datasets: config.datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: true, labels: { color: '#666', font: { size: 10 } } } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666' } },
                    x: { grid: { display: false }, ticks: { color: '#666' } }
                },
                indexAxis: config.type === 'bar' ? 'y' : 'x'
            }
        });
    }
    window.updateDynamicChart = function(value) {
        if (value === 'activity') renderDynamicChart(dataActivity);
        else if (value === 'top') renderDynamicChart(dataTop);
    };
    renderDynamicChart(dataActivity);
</script>
{% endblock %}