{% extends 'base.html' %}
{% load gallery_extras %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none transition-all duration-300"></div>
<div class="min-h-screen bg-[#050505] text-white font-sans flex flex-col selection:bg-white selection:text-black">
    <nav class="border-b border-white/10 bg-[#0a0a0a] px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-6">
          <a href="{% url 'dashboard' %}" class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Назад
          </a>
          <div class="h-6 w-[1px] bg-white/10"></div>
          <div>
              <h1 class="font-bold text-lg leading-none tracking-tight">{{ gallery.title }}</h1>
              <span class="text-[10px] text-gray-500 uppercase tracking-widest">Аналитика и Управление</span>
          </div>
        </div>
        <div class="flex gap-4 items-center">
             <label class="flex items-center gap-2 cursor-pointer text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white transition-colors select-none">
                 <div class="relative">
                     <input type="checkbox" id="authorToggle" class="sr-only peer" onchange="toggleAuthorStats(this)" {% if include_author %}checked{% endif %}>
                     <div class="w-8 h-4 bg-gray-700 rounded-full shadow-inner transition-colors duration-200 ease-in-out peer-checked:bg-white"></div>
                     <div class="absolute w-2 h-2 bg-white rounded-full shadow inset-y-1 left-1 transition-transform duration-200 ease-in-out peer-checked:translate-x-4 peer-checked:bg-black"></div>
                 </div>
                 <span>Учитывать автора</span>
             </label>
             <div class="hidden md:flex bg-[#111] rounded p-1 border border-[#222]">
                <button onclick="switchTab('OVERVIEW')" id="tab-btn-OVERVIEW" class="flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all bg-white text-black shadow-lg">
                    <i data-lucide="layout-dashboard" class="w-3.5 h-3.5"></i> Обзор
                </button>
                <button onclick="switchTab('PHOTOS')" id="tab-btn-PHOTOS" class="flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all text-gray-500 hover:text-white">
                    <i data-lucide="grid" class="w-3.5 h-3.5"></i> Фотографии
                </button>
            </div>
             <a href="{% url 'gallery_settings' gallery.id %}" class="w-10 h-10 flex items-center justify-center rounded-full border border-white/10 hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-4 h-4"></i>
             </a>
        </div>
    </nav>
    <main class="flex-1 p-6 md:p-8 max-w-[1920px] mx-auto w-full">
        <div id="tab-content-OVERVIEW" class="animate-in fade-in duration-500">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1 bg-[#0a0a0a] border border-white/10 p-6 rounded-sm h-[320px] flex flex-col relative overflow-hidden">
                    <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Воронка выбора</h3>
                    <div class="relative flex-1 flex items-center justify-center min-h-0 w-full">
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10">
                            <span class="text-3xl font-bold text-white">{{ selected_count }}</span>
                            <span class="text-[9px] text-gray-500 uppercase tracking-widest">Выбрано</span>
                        </div>
                        <div class="absolute inset-0">
                             <canvas id="kpiChart"></canvas>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between text-xs text-gray-400 px-2 pt-2 border-t border-white/5">
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-white"></div> Выбрано</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Просм.</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-[#333]"></div> Ост.</div>
                    </div>
                </div>
                <div class="lg:col-span-3 bg-[#0a0a0a] border border-white/10 p-6 rounded-sm h-[320px] flex flex-col">
                     <div class="flex justify-between items-center mb-4">
                         <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Динамика проекта</h3>
                         <select id="chartSelector" onchange="updateDynamicChart(this.value)" class="bg-[#111] text-white text-xs border border-[#333] rounded px-3 py-1 outline-none cursor-pointer hover:border-white transition-colors">
                             <option value="activity">Активность по дням</option>
                             <option value="top">Топ-10 фото</option>
                         </select>
                     </div>
                     <div class="flex-1 w-full relative min-h-0">
                        <canvas id="dynamicChart"></canvas>
                     </div>
                </div>
                <div class="lg:col-span-2 bg-[#0a0a0a] border border-white/10 rounded-sm overflow-hidden">
                    <div class="p-4 border-b border-white/10 bg-[#111]">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Просмотрели</h3>
                    </div>
                    <div class="p-4 max-h-[300px] overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left">
                            <tbody class="text-sm">
                                {% for access in viewers_list %}
                                <tr class="border-b border-[#222] last:border-0 hover:bg-[#111]">
                                    <td class="py-3 font-bold">{{ access.user.username }}</td>
                                    <td class="py-3 text-right font-mono text-xs text-gray-500">
                                        {{ access.last_viewed_at|timesince }} назад
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td class="py-4 text-center text-gray-600 text-xs">Нет просмотров</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-[#0a0a0a] border border-white/10 rounded-sm overflow-hidden">
                    <div class="p-4 border-b border-white/10 bg-[#111]">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Лайкнули</h3>
                    </div>
                    <div class="p-4 max-h-[300px] overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left">
                            <tbody class="text-sm">
                                {% for data in likers_data %}
                                <tr class="border-b border-[#222] last:border-0 hover:bg-[#111]">
                                    <td class="py-3 font-bold">{{ data.user.username }}</td>
                                    <td class="py-3 text-right">
                                        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded bg-[#222] text-white text-[10px] font-bold">
                                            <i data-lucide="heart" class="w-3 h-3 fill-white"></i> {{ data.count }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td class="py-4 text-center text-gray-600 text-xs">Нет лайков</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="lg:col-span-4 bg-[#111] border border-white/10 p-6 rounded-sm flex justify-between items-center">
                    <div>
                        <h3 class="text-xs font-bold text-white uppercase tracking-widest mb-1">Ссылка для клиента</h3>
                        <p class="text-[10px] text-gray-500 font-mono">{{ request.scheme }}://{{ request.get_host }}{% url 'gallery_detail' gallery.photographer.id gallery.id %}</p>
                    </div>
                    <button class="flex items-center gap-2 text-xs font-bold bg-white text-black px-4 py-2 rounded hover:bg-gray-200 transition-colors" onclick="copyLink()">
                        <i data-lucide="copy" class="w-3.5 h-3.5"></i> Скопировать
                    </button>
                </div>
            </div>
        </div>
        <div id="tab-content-PHOTOS" class="hidden animate-in slide-in-from-bottom-2 duration-500">
            <div class="bg-[#0a0a0a] border border-white/10 rounded-sm min-h-[calc(100vh-140px)] flex flex-col">
                <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-[#111] border-b border-white/10 text-[10px] font-bold uppercase tracking-widest text-gray-500">
                    <div class="col-span-2">Превью</div>
                    <div class="col-span-2">Имя</div>
                    <div class="col-span-2">Статус</div>
                    <div class="col-span-6">Комментарий</div>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-1 max-h-[70vh]">
                    {% for item in photos_data %}
                    <div class="grid grid-cols-12 gap-4 px-6 py-4 border-b border-[#222] items-center hover:bg-[#0f0f0f] transition-colors">
                        <div class="col-span-2 h-12 w-20 bg-[#111] overflow-hidden rounded border border-[#333]">
                            <img src="{{ item.thumbnail }}" class="w-full h-full object-cover" loading="lazy">
                        </div>
                        <div class="col-span-2 font-mono text-sm text-gray-300">{{ item.filename }}</div>
                        <div class="col-span-2">
                            {% if item.is_liked %}
                                <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded bg-white text-black text-[10px] font-bold uppercase tracking-wider">
                                    <i data-lucide="heart" class="w-3 h-3 fill-black"></i> Выбрано
                                </span>
                            {% else %}
                                <span class="text-gray-600 text-[10px] uppercase tracking-wider">—</span>
                            {% endif %}
                        </div>
                        <div class="col-span-6 text-sm text-gray-400 italic">
                            {% if item.comment %}"{{ item.comment }}"{% else %}-{% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-10 text-center text-gray-600 text-sm">Нет фотографий</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </main>
</div>
<script>
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgClass = isError ? 'bg-red-600 border-red-500' : 'bg-white border-white';
        const textClass = isError ? 'text-white' : 'text-black';
        toast.className = `pointer-events-auto transform translate-y-[-20px] opacity-0 transition-all duration-300 flex items-center justify-between gap-4 px-6 py-3 rounded shadow-2xl border ${bgClass} ${textClass} min-w-[300px] max-w-md`;
        toast.innerHTML = `<div class="flex items-center gap-3"><i data-lucide="${isError ? 'alert-circle' : 'check-circle'}" class="w-5 h-5"></i><span class="text-xs font-bold uppercase tracking-widest">${message}</span></div>`;
        container.appendChild(toast);
        lucide.createIcons();
        requestAnimationFrame(() => toast.classList.remove('translate-y-[-20px]', 'opacity-0'));
        setTimeout(() => { toast.classList.add('translate-y-[-20px]', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
    function toggleAuthorStats(checkbox) {
        const url = new URL(window.location);
        if (checkbox.checked) {
            url.searchParams.set('include_author', 'true');
        } else {
            url.searchParams.delete('include_author');
        }
        window.location.href = url.toString();
    }
    function switchTab(tabName) {
        document.getElementById('tab-content-OVERVIEW').classList.add('hidden');
        document.getElementById('tab-content-PHOTOS').classList.add('hidden');
        document.getElementById('tab-btn-OVERVIEW').className = "flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all text-gray-500 hover:text-white";
        document.getElementById('tab-btn-PHOTOS').className = "flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all text-gray-500 hover:text-white";
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
        document.getElementById('tab-btn-' + tabName).className = "flex items-center gap-2 px-6 py-2 rounded text-[10px] font-bold uppercase tracking-widest transition-all bg-white text-black shadow-lg";
    }
    function copyLink() {
        const url = "{{ request.scheme }}://{{ request.get_host }}{% url 'gallery_detail' gallery.photographer.id gallery.id %}";
        navigator.clipboard.writeText(url);
        showToast('Ссылка скопирована!');
    }
    document.addEventListener("DOMContentLoaded", function() {
        {% if messages %}
            {% for message in messages %}
                showToast("{{ message }}", "{{ message.tags }}" === "error");
            {% endfor %}
        {% endif %}
    });
    new Chart(document.getElementById('kpiChart'), {
        type: 'doughnut',
        data: {
            labels: ['Выбрано', 'Просмотрено', 'Не просмотрено'],
            datasets: [{
                data: [{{ selected_count }}, {{ viewed_count }}, {{ unviewed_count }}],
                backgroundColor: ['#ffffff', '#3b82f6', '#333333'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: { legend: { display: false } }
        }
    });
    let dynamicChartInstance = null;
    const ctxDynamic = document.getElementById('dynamicChart').getContext('2d');
    const dataActivity = {
        type: 'line',
        labels: {{ activity_dates|safe }},
        dataset: {
            label: 'Активность',
            data: {{ activity_counts|safe }},
            borderColor: '#ffffff',
            backgroundColor: 'rgba(255,255,255,0.1)',
            fill: true,
            tension: 0.4
        }
    };
    const dataTop = {
        type: 'bar',
        labels: {{ top_labels|safe }},
        dataset: {
            label: 'Лайки',
            data: {{ top_data|safe }},
            backgroundColor: '#22c55e',
            borderRadius: 4
        }
    };
    function renderDynamicChart(config) {
        if (dynamicChartInstance) dynamicChartInstance.destroy();
        dynamicChartInstance = new Chart(ctxDynamic, {
            type: config.type,
            data: { labels: config.labels, datasets: [config.dataset] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666' } },
                    x: { grid: { display: false }, ticks: { color: '#666' } }
                },
                indexAxis: config.type === 'bar' ? 'y' : 'x'
            }
        });
    }
    window.updateDynamicChart = function(value) {
        if (value === 'activity') renderDynamicChart(dataActivity);
        else if (value === 'top') renderDynamicChart(dataTop);
    };
    renderDynamicChart(dataActivity);
</script>
{% endblock %}