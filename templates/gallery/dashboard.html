{% extends 'base.html' %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none transition-all duration-300"></div>
<div class="min-h-screen bg-[#050505] text-white font-sans flex flex-col">
    <nav class="border-b border-white/10 bg-[#0a0a0a] px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-4">
          <a href="{% url 'landing' %}" class="flex items-center gap-2 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Главная
          </a>
          <div class="h-6 w-[1px] bg-white/10"></div>
          <div>
              <h1 class="font-bold text-lg leading-none tracking-tight truncate max-w-[150px] sm:max-w-none">Кабинет Фотографа</h1>
              <span class="text-[10px] text-gray-500 uppercase tracking-widest hidden sm:block">{{ user.username }}</span>
          </div>
        </div>
        <div class="flex gap-2 md:gap-4 items-center">
             <label class="flex items-center gap-2 cursor-pointer text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white transition-colors select-none">
                 <div class="relative">
                     <input type="checkbox" id="authorToggle" class="sr-only peer" onchange="toggleAuthorStats(this)" {% if include_author %}checked{% endif %}>
                     <div class="w-8 h-4 bg-gray-700 rounded-full shadow-inner transition-colors duration-200 ease-in-out peer-checked:bg-white"></div>
                     <div class="absolute w-2 h-2 bg-white rounded-full shadow inset-y-1 left-1 transition-transform duration-200 ease-in-out peer-checked:translate-x-4 peer-checked:bg-black"></div>
                 </div>
                 <span class="hidden md:block">Учитывать автора</span>
             </label>
             <button class="w-9 h-9 md:w-10 md:h-10 flex items-center justify-center rounded-full border border-white/10 hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
             </button>
        </div>
    </nav>
    <main class="flex-1 p-4 md:p-8 max-w-[1920px] mx-auto w-full">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-[#111] border border-white/10 p-6 rounded-sm">
                <span class="text-xs text-gray-500 uppercase tracking-widest">Всего галерей</span>
                <div class="text-3xl font-bold mt-2">{{ total_galleries }}</div>
            </div>
            <div class="bg-[#111] border border-white/10 p-6 rounded-sm">
                <span class="text-xs text-gray-500 uppercase tracking-widest">Всего лайков</span>
                <div class="text-3xl font-bold mt-2 text-green-400">{{ total_likes_global }}</div>
            </div>
            <div class="md:col-span-2 bg-[#111] border border-white/10 p-6 rounded-sm flex items-center justify-between">
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-widest">Быстрый старт</span>
                    <div class="text-lg font-bold mt-1 text-white">Создать новый проект</div>
                </div>
                <a href="{% url 'gallery_create' %}" class="bg-white text-black px-6 py-3 text-xs font-bold uppercase tracking-widest hover:bg-gray-200 transition-colors flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Создать
                </a>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-[#0a0a0a] border border-white/10 p-6 rounded-sm h-[300px] flex flex-col">
                 <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Топ-5 проектов по отклику</h3>
                 <div class="relative w-full flex-1 min-h-0">
                    <canvas id="barChart"></canvas>
                 </div>
            </div>
            <div class="lg:col-span-1 bg-[#0a0a0a] border border-white/10 p-6 rounded-sm h-[300px] flex flex-col">
                 <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Статус проектов</h3>
                 <div class="relative w-full flex-1 min-h-0 flex justify-center">
                    <canvas id="doughnutChart"></canvas>
                 </div>
            </div>
        </div>
        <div class="bg-[#0a0a0a] border border-white/10 rounded-sm overflow-hidden">
            <div class="p-4 border-b border-white/10 bg-[#111]">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Все Галереи</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[10px] font-bold uppercase tracking-widest text-gray-500 border-b border-[#222]">
                            <th class="p-4">Название</th>
                            <th class="p-4">Лайки</th>
                            <th class="p-4">Срок</th>
                            <th class="p-4">Статус</th>
                            <th class="p-4 text-right">Действия</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm text-gray-300">
                        {% for gallery in galleries %}
                        <tr class="border-b border-[#222] hover:bg-[#0f0f0f] transition-colors">
                            <td class="p-4 font-bold text-white">
                                <a href="{% url 'gallery_detail' gallery.photographer.id gallery.id %}" class="hover:underline">{{ gallery.title }}</a>
                            </td>
                            <td class="p-4 font-mono text-xs">
                                <div class="flex items-center gap-2 leading-none">
                                    <i data-lucide="heart" class="w-3 h-3 text-gray-500 mb-[1px]"></i> <span>{{ gallery.total_likes_count }}</span>
                                </div>
                            </td>
                            <td class="p-4 font-mono">{{ gallery.expires_at|date:"d.m.Y" }}</td>
                            <td class="p-4">
                                {% if gallery.is_active %}<span class="text-green-500 font-bold">●</span>{% else %}<span class="text-gray-500">○</span>{% endif %}
                            </td>
                            <td class="p-4 text-right">
                                <div class="flex justify-end gap-2">
                                    <a href="{% url 'gallery_analytics' gallery.id %}{% if include_author %}?include_author=true{% endif %}" class="inline-flex items-center justify-center text-[10px] font-bold uppercase tracking-widest bg-[#222] hover:bg-white hover:text-black text-white px-3 py-1.5 border border-white/10 transition-colors" title="Аналитика">
                                        <i data-lucide="bar-chart-2" class="w-3 h-3 mr-1"></i> Аналитика
                                    </a>
                                    <a href="{% url 'gallery_access' gallery.id %}" class="inline-flex items-center justify-center text-[10px] font-bold uppercase tracking-widest bg-[#222] hover:bg-white hover:text-black text-white px-3 py-1.5 border border-white/10 transition-colors">
                                        <i data-lucide="users" class="w-3 h-3"></i>
                                    </a>
                                    <a href="{% url 'gallery_settings' gallery.id %}" class="inline-flex items-center justify-center text-[10px] font-bold uppercase tracking-widest bg-[#222] hover:bg-white hover:text-black text-white px-3 py-1.5 border border-white/10 transition-colors">
                                        <i data-lucide="settings" class="w-3 h-3"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="p-8 text-center text-gray-500">Нет галерей</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>
<script>
    function showToast(message, isError = false) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgClass = isError ? 'bg-red-600 border-red-500' : 'bg-white border-white';
        const textClass = isError ? 'text-white' : 'text-black';
        toast.className = `pointer-events-auto transform translate-y-[-20px] opacity-0 transition-all duration-300 flex items-center justify-between gap-4 px-6 py-3 rounded shadow-2xl border ${bgClass} ${textClass} min-w-[300px] max-w-md`;
        toast.innerHTML = `<div class="flex items-center gap-3"><i data-lucide="${isError ? 'alert-circle' : 'check-circle'}" class="w-5 h-5"></i><span class="text-xs font-bold uppercase tracking-widest">${message}</span></div>`;
        container.appendChild(toast);
        lucide.createIcons();
        requestAnimationFrame(() => toast.classList.remove('translate-y-[-20px]', 'opacity-0'));
        setTimeout(() => { toast.classList.add('translate-y-[-20px]', 'opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
    function toggleAuthorStats(checkbox) {
        const url = new URL(window.location);
        if (checkbox.checked) {
            url.searchParams.set('include_author', 'true');
        } else {
            url.searchParams.delete('include_author');
        }
        window.location.href = url.toString();
    }
    // Init Toasts on load
    document.addEventListener("DOMContentLoaded", function() {
        {% if messages %}
            {% for message in messages %}
                showToast("{{ message }}", "{{ message.tags }}" === "error");
            {% endfor %}
        {% endif %}
    });
    const ctx = document.getElementById('barChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ chart_top_labels|safe }},
            datasets: [{
                label: 'Лайки',
                data: {{ chart_top_data|safe }},
                backgroundColor: '#ffffff',
                borderRadius: 2,
                barThickness: 30
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#222' }, ticks: { color: '#666' } },
                x: { grid: { display: false }, ticks: { color: '#999' } }
            }
        }
    });
    new Chart(document.getElementById('doughnutChart'), {
        type: 'doughnut',
        data: {
            labels: ['Активные', 'Закрытые'],
            datasets: [{
                data: {{ chart_status_data|safe }},
                backgroundColor: ['#22c55e', '#333333'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'bottom', labels: { color: '#999', usePointStyle: true } } 
            },
            cutout: '70%'
        }
    });
</script>
{% endblock %}